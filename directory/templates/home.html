{% extends "base.html" %}
{% load dict_extras %}

{% block extra_head %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "Sauna Guide",
  "url": "https://saunaguide.ie",
  "description": "Find the best saunas in Ireland. Browse our comprehensive directory of sauna facilities, wellness centers, and spa experiences across Ireland.",
  "publisher": {
    "@type": "Organization",
    "name": "Sauna Guide",
    "url": "https://saunaguide.ie"
  },
  "potentialAction": {
    "@type": "SearchAction",
    "target": "https://saunaguide.ie/?city={search_term_string}",
    "query-input": "required name=search_term_string"
  }
}
</script>
{% if map_enabled %}
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    {% if map_provider == "google" and google_maps_api_key %}
        <script
            src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}"
            defer
        ></script>
    {% else %}
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
    {% endif %}
{% endif %}
{% endblock %}

{% block content %}
<div class="mb-8">
    <h2 class="text-3xl sm:text-4xl font-bold text-slate-900 mb-2">Sauna Guide: Explore Saunas in Ireland</h2>
    <p class="text-lg text-slate-600">Find your perfect sauna experience with Sauna Guide's filters</p>
</div>

<div class="grid gap-6 lg:grid-cols-[300px_1fr]">
    <aside class="lg:sticky lg:top-24 h-fit">
        <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-lg">
            <h2 class="text-xl font-bold text-slate-900 mb-1">Filters</h2>
            <p class="text-sm text-slate-500 mb-4">Refine your search</p>
            <form
                class="flex flex-col h-[calc(100vh-10rem)]"
                hx-get="."
                hx-trigger="change delay:200ms"
                hx-target="#listing-results"
                hx-swap="innerHTML"
                hx-push-url="true"
                hx-indicator="#loading"
            >
                <div class="space-y-4 overflow-y-auto pr-2 pb-4">
                    <div class="pb-3 border-b border-slate-100">
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Near me</label>
                        <label class="flex items-center gap-3 cursor-pointer group">
                            <input
                                type="checkbox"
                                id="near-me-toggle"
                                name="near_me"
                                value="1"
                                class="h-5 w-5 rounded border-slate-300 text-primary focus:ring-primary focus:ring-2"
                                {% if near_me_active %}checked{% endif %}
                            />
                            <span class="text-sm text-slate-600 group-hover:text-slate-900 transition-colors">Use my location</span>
                        </label>
                        <div class="mt-3">
                            <div class="flex items-center justify-between">
                                <label class="text-xs font-semibold text-slate-600">Distance (km)</label>
                                <span id="distance-km-value" class="text-xs font-semibold text-slate-900">{{ near_me_distance_km|default:50 }}</span>
                            </div>
                            <input
                                type="range"
                                id="distance-km"
                                name="distance_km"
                                min="5"
                                max="100"
                                step="5"
                                value="{{ near_me_distance_km|default:50 }}"
                                class="mt-2 w-full accent-primary"
                            />
                        </div>
                        <input type="hidden" id="user-lat" name="lat" value="{{ user_lat|default:'' }}" />
                        <input type="hidden" id="user-lng" name="lng" value="{{ user_lng|default:'' }}" />
                        <p id="near-me-status" class="mt-2 text-xs text-slate-500">Share your location to find saunas near you.</p>
                    </div>
                    {% for filter in filters %}
                        <div class="pb-3 border-b border-slate-100 last:border-0">
                            <label class="block text-sm font-semibold text-slate-700 mb-2">{{ filter.label }}</label>
                            {% if filter.type == "boolean" %}
                                <label class="flex items-center gap-3 cursor-pointer group">
                                    <input
                                        type="checkbox"
                                        name="{{ filter.key }}"
                                        value="true"
                                        class="h-5 w-5 rounded border-slate-300 text-primary focus:ring-primary focus:ring-2"
                                        {% if request.GET|dict_get:filter.key %}checked{% endif %}
                                    />
                                    <span class="text-sm text-slate-600 group-hover:text-slate-900 transition-colors">Available</span>
                                </label>
                            {% else %}
                                <select
                                    name="{{ filter.key }}"
                                    class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all"
                                >
                                    <option value="">All Options</option>
                                    {% for choice in filter.choices %}
                                        <option value="{{ choice }}" {% if request.GET|dict_get:filter.key == choice %}selected{% endif %}>{{ choice }}</option>
                                    {% endfor %}
                                </select>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
                <div class="pt-3">
                    <a href="." class="w-full inline-flex items-center justify-center gap-2 text-center rounded-lg bg-gradient-to-r from-primary to-secondary px-4 py-3 text-sm font-semibold text-white shadow-lg hover:shadow-xl transition-all hover:scale-[1.02]">
                        <span id="loading" class="htmx-indicator inline-block">‚è≥ </span>
                        Reset Filters
                    </a>
                </div>
            </form>
        </div>
    </aside>

    <section>
        <div id="listing-results">
            {% include "partials/listing_results.html" %}
        </div>
        
        <!-- SEO Content Section -->
        <div class="mt-12 space-y-8">
            <div class="rounded-2xl border border-slate-200 bg-white p-8 shadow-md">
                <h2 class="text-2xl font-bold text-slate-900 mb-4">Why Choose Sauna Guide?</h2>
                <p class="text-slate-700 leading-relaxed mb-4">
                    Sauna Guide is Ireland's most comprehensive directory of sauna facilities, wellness centers, and spa experiences. 
                    Whether you're looking for a traditional Finnish sauna, an infrared sauna, or a luxurious spa day, we help you 
                    discover the perfect sauna experience near you.
                </p>
                <p class="text-slate-700 leading-relaxed">
                    Browse verified listings across Dublin, Cork, Galway, and every county in Ireland. Filter by amenities, ratings, 
                    and location to find exactly what you're looking for.
                </p>
            </div>
            
            <div class="grid md:grid-cols-2 gap-6">
                <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-md">
                    <h3 class="text-xl font-bold text-slate-900 mb-3">‚ú® Health Benefits of Saunas</h3>
                    <ul class="space-y-2 text-slate-700">
                        <li>‚Ä¢ Improved cardiovascular health and circulation</li>
                        <li>‚Ä¢ Stress relief and mental relaxation</li>
                        <li>‚Ä¢ Muscle recovery and pain relief</li>
                        <li>‚Ä¢ Enhanced skin health and detoxification</li>
                        <li>‚Ä¢ Better sleep quality</li>
                    </ul>
                </div>
                
                <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-md">
                    <h3 class="text-xl font-bold text-slate-900 mb-3">üîç How to Choose a Sauna</h3>
                    <ul class="space-y-2 text-slate-700">
                        <li>‚Ä¢ <strong>Type:</strong> Traditional, infrared, or steam room?</li>
                        <li>‚Ä¢ <strong>Location:</strong> Find saunas near you</li>
                        <li>‚Ä¢ <strong>Amenities:</strong> Cold plunge, outdoor space, private rooms</li>
                        <li>‚Ä¢ <strong>Reviews:</strong> Check ratings and user feedback</li>
                        <li>‚Ä¢ <strong>Price:</strong> Compare value across facilities</li>
                    </ul>
                </div>
            </div>
            
            <div class="rounded-2xl border border-slate-200 bg-white p-8 shadow-md">
                <h3 class="text-2xl font-bold text-slate-900 mb-4">Frequently Asked Questions</h3>
                <div class="space-y-4">
                    <div>
                        <h4 class="font-semibold text-slate-900 mb-2">How often should I use a sauna?</h4>
                        <p class="text-slate-700">Most health experts recommend 2-3 sauna sessions per week for optimal benefits. Always listen to your body and consult a healthcare provider if you have medical conditions.</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-slate-900 mb-2">What's the difference between traditional and infrared saunas?</h4>
                        <p class="text-slate-700">Traditional saunas heat the air around you (typically 70-100¬∞C), while infrared saunas use infrared light to heat your body directly at lower temperatures (45-60¬∞C). Both offer unique benefits.</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-slate-900 mb-2">Are saunas safe for everyone?</h4>
                        <p class="text-slate-700">While saunas are generally safe, pregnant women, people with heart conditions, and those with certain medical conditions should consult their doctor before using a sauna.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

{% if map_enabled %}
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const mapState = {
            map: null,
            markers: [],
            userMarker: null,
            provider: null,
            initFailed: false,
        };

        let handlersInitialized = false;

        const getMapPanel = () => document.getElementById("map-panel");
        const getMapData = () => {
            const mapDataEl = document.getElementById("map-data");
            if (!mapDataEl) {
                return [];
            }
            try {
                return JSON.parse(mapDataEl.textContent || "[]");
            } catch (error) {
                return [];
            }
        };

        const updateDistanceLabel = () => {
            const input = document.getElementById("distance-km");
            const label = document.getElementById("distance-km-value");
            if (input && label) {
                label.textContent = input.value;
            }
        };

        const updateStatus = (message) => {
            const status = document.getElementById("near-me-status");
            if (status) {
                status.textContent = message;
            }
            const mapStatus = document.getElementById("map-status");
            if (mapStatus) {
                mapStatus.textContent = message;
            }
        };

        const getStoredLocation = () => {
            const lat = sessionStorage.getItem('userLat');
            const lng = sessionStorage.getItem('userLng');
            return (lat && lng) ? { lat: parseFloat(lat), lng: parseFloat(lng) } : null;
        };

        const setLocationInputs = (lat, lng) => {
            // Store in sessionStorage for privacy (not exposed in URL/logs)
            sessionStorage.setItem('userLat', lat);
            sessionStorage.setItem('userLng', lng);
            
            // Also set hidden inputs for form submission
            const latInput = document.getElementById("user-lat");
            const lngInput = document.getElementById("user-lng");
            if (latInput && lngInput) {
                latInput.value = lat;
                lngInput.value = lng;
            }
        };

        const clearLocationInputs = () => {
            sessionStorage.removeItem('userLat');
            sessionStorage.removeItem('userLng');
            const latInput = document.getElementById("user-lat");
            const lngInput = document.getElementById("user-lng");
            if (latInput && lngInput) {
                latInput.value = '';
                lngInput.value = '';
            }
        };

        const requestLocation = () => new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
                reject(new Error("Geolocation not supported"));
                return;
            }
            navigator.geolocation.getCurrentPosition(
                (position) => resolve(position.coords),
                (error) => reject(error),
                { enableHighAccuracy: false, timeout: 10000, maximumAge: 60000 }
            );
        });

        const triggerFilterRefresh = () => {
            const form = document.querySelector("form[hx-get]");
            if (form && window.htmx) {
                window.htmx.trigger(form, "change");
            }
        };

        const ensureLocation = async () => {
            // Check if we already have a stored location
            const stored = getStoredLocation();
            if (stored) {
                setLocationInputs(stored.lat, stored.lng);
                return { lat: stored.lat, lng: stored.lng };
            }

            updateStatus("Requesting your location...");
            try {
                const coords = await requestLocation();
                const lat = coords.latitude.toFixed(6);
                const lng = coords.longitude.toFixed(6);
                setLocationInputs(lat, lng);
                updateStatus("Location added. Updating results...");
                return { lat: parseFloat(lat), lng: parseFloat(lng) };
            } catch (error) {
                updateStatus("Location access denied. You can keep browsing without Near Me.");
                return null;
            }
        };

        const clearLeafletMarkers = () => {
            mapState.markers.forEach((marker) => marker.remove());
            mapState.markers = [];
            if (mapState.userMarker) {
                mapState.userMarker.remove();
                mapState.userMarker = null;
            }
        };

        const addLeafletUserMarker = (lat, lng) => {
            if (!mapState.map || mapState.provider !== "leaflet" || !window.L) {
                return;
            }
            // Create a custom blue circle marker for user location
            const userIcon = window.L.divIcon({
                className: 'user-location-marker',
                html: '<div style="background: #3b82f6; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 8px rgba(0,0,0,0.3);"></div>',
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });
            mapState.userMarker = window.L.marker([lat, lng], { icon: userIcon })
                .addTo(mapState.map)
                .bindPopup("<strong>You are here</strong>");
        };

        const initLeafletMap = (panel) => {
            const mapContainer = document.getElementById("sauna-map");
            if (!mapContainer || !window.L) {
                return;
            }

            try {
                const defaultLat = parseFloat(panel.dataset.defaultLat || "53.1424");
                const defaultLng = parseFloat(panel.dataset.defaultLng || "-7.6921");
                const defaultZoom = parseInt(panel.dataset.defaultZoom || "7", 10);
                mapState.map = window.L.map(mapContainer).setView([defaultLat, defaultLng], defaultZoom);
                window.L.tileLayer(panel.dataset.tileUrl, {
                    attribution: panel.dataset.tileAttribution,
                    maxZoom: 19,
                }).addTo(mapState.map);
                mapState.provider = "leaflet";
                mapState.initFailed = false;
            } catch (error) {
                console.error("Leaflet map initialization failed:", error);
                updateStatus("Map unavailable. Please refresh the page.");
                mapState.initFailed = true;
            }
        };

        const updateLeafletMarkers = (panel, data) => {
            if (!mapState.map || mapState.provider !== "leaflet") {
                return;
            }
            clearLeafletMarkers();

            const bounds = [];
            const userLocation = getStoredLocation();
            
            // Add user location marker if available
            if (userLocation) {
                addLeafletUserMarker(userLocation.lat, userLocation.lng);
                bounds.push([userLocation.lat, userLocation.lng]);
            }

            data.forEach((listing) => {
                if (listing.lat == null || listing.lng == null) {
                    return;
                }
                const marker = window.L.marker([listing.lat, listing.lng]).addTo(mapState.map);
                const distanceText = listing.distance_km ? ` (${listing.distance_km} km)` : "";
                marker.bindPopup(`<strong>${listing.name}</strong><br/>${listing.city}${distanceText}<br/><a href="${listing.url}">View</a>`);
                mapState.markers.push(marker);
                bounds.push([listing.lat, listing.lng]);
            });

            if (bounds.length > 0) {
                mapState.map.fitBounds(bounds, { padding: [24, 24] });
            } else {
                const defaultLat = parseFloat(panel.dataset.defaultLat || "53.1424");
                const defaultLng = parseFloat(panel.dataset.defaultLng || "-7.6921");
                const defaultZoom = parseInt(panel.dataset.defaultZoom || "7", 10);
                mapState.map.setView([defaultLat, defaultLng], defaultZoom);
            }
        };

        const initGoogleMap = (panel) => {
            const mapContainer = document.getElementById("sauna-map");
            if (!mapContainer || !window.google || !window.google.maps) {
                return;
            }
            try {
                const defaultLat = parseFloat(panel.dataset.defaultLat || "53.1424");
                const defaultLng = parseFloat(panel.dataset.defaultLng || "-7.6921");
                const defaultZoom = parseInt(panel.dataset.defaultZoom || "7", 10);
                mapState.map = new window.google.maps.Map(mapContainer, {
                    center: { lat: defaultLat, lng: defaultLng },
                    zoom: defaultZoom,
                    mapTypeControl: false,
                    fullscreenControl: false,
                });
                mapState.provider = "google";
                mapState.initFailed = false;
            } catch (error) {
                console.error("Google Maps initialization failed:", error);
                updateStatus("Map unavailable. Please refresh the page.");
                mapState.initFailed = true;
            }
        };

        const updateGoogleMarkers = (panel, data) => {
            if (!mapState.map || mapState.provider !== "google" || !window.google || !window.google.maps) {
                return;
            }
            mapState.markers.forEach((marker) => marker.setMap(null));
            mapState.markers = [];
            if (mapState.userMarker) {
                mapState.userMarker.setMap(null);
                mapState.userMarker = null;
            }

            const bounds = new window.google.maps.LatLngBounds();
            let hasBounds = false;
            const userLocation = getStoredLocation();
            
            // Add user location marker if available
            if (userLocation) {
                mapState.userMarker = new window.google.maps.Marker({
                    map: mapState.map,
                    position: { lat: userLocation.lat, lng: userLocation.lng },
                    title: "You are here",
                    icon: {
                        path: window.google.maps.SymbolPath.CIRCLE,
                        scale: 8,
                        fillColor: "#3b82f6",
                        fillOpacity: 1,
                        strokeColor: "white",
                        strokeWeight: 3,
                    },
                });
                bounds.extend(mapState.userMarker.getPosition());
                hasBounds = true;
            }

            data.forEach((listing) => {
                if (listing.lat == null || listing.lng == null) {
                    return;
                }
                const marker = new window.google.maps.Marker({
                    map: mapState.map,
                    position: { lat: listing.lat, lng: listing.lng },
                    title: listing.name,
                });
                const distanceText = listing.distance_km ? ` (${listing.distance_km} km)` : "";
                const info = new window.google.maps.InfoWindow({
                    content: `<strong>${listing.name}</strong><br/>${listing.city}${distanceText}<br/><a href="${listing.url}">View</a>`,
                });
                marker.addListener("click", () => info.open({ anchor: marker, map: mapState.map }));
                mapState.markers.push(marker);
                bounds.extend(marker.getPosition());
                hasBounds = true;
            });

            if (hasBounds) {
                mapState.map.fitBounds(bounds, 48);
            }
        };

        const renderMap = () => {
            const panel = getMapPanel();
            if (!panel) {
                return;
            }
            if (panel.classList.contains("hidden")) {
                return;
            }
            if (mapState.initFailed) {
                return; // Don't retry if previous initialization failed
            }
            const data = getMapData();
            const provider = panel.dataset.mapProvider || "leaflet";

            if (!mapState.map) {
                if (provider === "google") {
                    initGoogleMap(panel);
                } else {
                    initLeafletMap(panel);
                }
            }

            if (provider === "google") {
                updateGoogleMarkers(panel, data);
            } else {
                updateLeafletMarkers(panel, data);
            }
        };

        const handleNearMeToggle = async (event) => {
            if (!event.target.checked) {
                clearLocationInputs();
                updateStatus("Near Me disabled. You can browse all listings.");
                // Immediately update visible map before HTMX refresh
                if (!getMapPanel()?.classList.contains("hidden")) {
                    renderMap();
                }
                triggerFilterRefresh();
                return;
            }
            const location = await ensureLocation();
            if (!location) {
                event.target.checked = false;
                return;
            }
            triggerFilterRefresh();
        };

        const handleMapToggle = async () => {
            const panel = getMapPanel();
            if (!panel) {
                return;
            }
            panel.classList.toggle("hidden");

            if (!panel.classList.contains("hidden")) {
                const stored = getStoredLocation();
                if (!stored) {
                    const nearMeToggle = document.getElementById("near-me-toggle");
                    if (nearMeToggle && !nearMeToggle.checked) {
                        const location = await ensureLocation();
                        if (location) {
                            nearMeToggle.checked = true;
                            triggerFilterRefresh();
                        }
                    }
                }
                renderMap();
            }
        };

        const setupHandlers = () => {
            if (handlersInitialized) {
                return; // Prevent duplicate event listeners
            }
            handlersInitialized = true;

            const nearMeToggle = document.getElementById("near-me-toggle");
            const distanceInput = document.getElementById("distance-km");

            if (nearMeToggle) {
                nearMeToggle.addEventListener("change", handleNearMeToggle);
                if (nearMeToggle.checked) {
                    updateStatus("Location enabled. Adjust distance to refine.");
                } else {
                    // Clear stale coordinates on page load if Near Me is not active
                    const latInput = document.getElementById("user-lat");
                    const lngInput = document.getElementById("user-lng");
                    if (latInput?.value || lngInput?.value) {
                        clearLocationInputs();
                    }
                }
            }
            if (distanceInput) {
                distanceInput.addEventListener("input", updateDistanceLabel);
                // Auto-refresh when distance slider changes (if Near Me is active)
                distanceInput.addEventListener("change", () => {
                    const nearMeToggle = document.getElementById("near-me-toggle");
                    if (nearMeToggle?.checked) {
                        triggerFilterRefresh();
                    }
                });
                updateDistanceLabel();
            }
        };

        document.addEventListener("click", (event) => {
            const toggle = event.target.closest("[data-map-toggle]");
            if (toggle) {
                handleMapToggle();
            }
        });

        document.body.addEventListener("htmx:afterSwap", (event) => {
            if (event.target && event.target.id === "listing-results") {
                // Don't destroy the map instance, just update markers
                setupHandlers();
                if (!getMapPanel()?.classList.contains("hidden")) {
                    renderMap();
                }
            }
        });

        setupHandlers();
    });
</script>
{% endif %}
{% endblock %}
